import 'dart:io';

import 'package:antlr4/antlr4.dart';
import 'package:path/path.dart';

import '../common.dart';
import '../../parser/java/Java9Parser.dart';
import 'dn_java_generater.dart';

class ListOpNode {
  ListOpNode pre;

  ListOpNode enter(ListOpNode enterWhich) {
    pre = enterWhich;
    return this;
  }

  ListOpNode exit() {
    return pre;
  }
}

class DNContext extends ListOpNode {
  ParserRuleContext internal;
  DNContext parent;
  List<DNContext> children;

  DNContext(internal) {
    this.internal = internal;
    this.parent = null;
    this.children = [];
  }

  String parse() {
    return '';
  }

  @override
  ListOpNode enter(ListOpNode enterWhich) {
    if (enterWhich is DNContext) {
      DNContext ctx = enterWhich;
      this.parent = ctx;
      ctx.children.add(this);
    }
    return super.enter(enterWhich);
  }

  @override
  ListOpNode exit() {
    return super.exit();
  }
}

class DNRootContext extends DNContext {
  String packageName;
  JavaFile javaFile;

  // 只有接口/属性里面import的class才会被生成代码
  List<ImportDeclarationContext> _rawImportList = [];
  List<String> _realImportStatement = [];

  // data from imports, record class name and javafile
  Map<String, JavaFile> _importFileMapWithName = {};
  bool _isInitImports = false;

  DNRootContext(internal, JavaFile javaFile) : super(internal) {
    this.javaFile = javaFile;
    this.javaFile.resolve = true;
    CompileContext.getContext().pushFile(this.javaFile);
    CompileContext.getContext().setCurrentCompileRootContext(this);
  }

  void setPackageName(String packageName) {
    this.packageName = packageName;
  }

  void addImport(ImportDeclarationContext import) {
    _rawImportList.add(import);
  }

  String convertType2Dart(String javaType) {
    if (!_isInitImports) {
      _initImports();
    }
    if (_importFileMapWithName.containsKey(javaType)) {
      JavaFile importJavaFile = _importFileMapWithName[javaType];
      // mark 不加dirname会以具体的file做单位，比如 (/A/A.java, /B/B.java) 会生成 ../../B/B.java，实际上应该 ../B/B.java
      String relativePath =
          relative(importJavaFile.path, from: dirname(this.javaFile.path));
      relativePath = relativePath.replaceAll(".java", ".dart");
      String statement = "import '${normalize(relativePath)}';";
      if (!_realImportStatement.contains(statement)) {
        _realImportStatement.add(statement);
      }
      CompileContext.getContext().pushFile(importJavaFile);
      return javaType;
    }
    return javaType;
  }

  void _initImportWithOneFile(File file) {
    String javaFileNameNoExt = basenameWithoutExtension(file.path);
    if (javaFileNameNoExt == null) {
      return;
    }
    JavaFile javaFile = new JavaFile();
    javaFile.path = file.path;
    if (!file.existsSync()) {
      javaFile.fileType = FILE_TYPE.aar;
      javaFile.resolve = true;
    } else {
      javaFile.fileType = FILE_TYPE.source_file;
    }
    _importFileMapWithName[javaFileNameNoExt] = javaFile;
  }

  void _initImports() {
    _rawImportList.forEach((import) {
      String importStatement =
          import.singleTypeImportDeclaration()?.typeName()?.text;
      String myJavaFilePath = javaFile.path;
      // win ?
      String fileSep = "/";

      String myPackagePath = packageName.replaceAll(".", fileSep);
      int myPackagePathIndex = myJavaFilePath.indexOf(myPackagePath);
      if (myPackagePathIndex < 0) {
        logger.severe("cannot find package path: ${packageName}");
        return;
      }

      String rootFilePath = myJavaFilePath.substring(0, myPackagePathIndex);
      String destFilePath =
          rootFilePath + importStatement.replaceAll(".", fileSep);
      if (destFilePath.endsWith(";")) {
        destFilePath = destFilePath.substring(0, destFilePath.length - 1);
      }

      bool isDir = destFilePath.endsWith("*");
      if (isDir) {
        destFilePath = destFilePath.replaceAll('${fileSep}*', fileSep);
      } else {
        destFilePath = destFilePath + ".java";
      }

      // new java file
      if (isDir) {
        Directory dir = new Directory(destFilePath);
        if (!dir.existsSync()) {
          return;
        }
        List<FileSystemEntity> dirSubFiles = dir.listSync();
        dirSubFiles.forEach((file) {
          if (file is File) {
            _initImportWithOneFile(file);
          }
        });
      }

      File destFile = new File(destFilePath);
      _initImportWithOneFile(destFile);
    });
    _isInitImports = true;
  }

  parse() {
    String header = _parseHeader();
    String body = _parseBody();
    // import 要在body后，因为parseBody内会触发对import的计算
    String import = _parseImport();
    return ('${header}\n${import}\n${body}');
  }

  String _parseHeader() {
    var result = '';
    result +=
        '// Generated by dart_native_codegen.\n// https://pub.dev/packages/dart_native_codegen\n\n';
    result += "import 'dart:ffi';\n\n";
    result += "import 'package:dart_native/dart_native.dart';\n";
    result += "import 'package:dart_native_gen/dart_native_gen.dart';";
    return result;
  }

  String _parseImport() {
    String importStatement = '';
    _realImportStatement.forEach((s) {
      importStatement += '${s}\n';
    });
    return importStatement;
  }

  String _parseBody() {
    return this.children.map((ctx) => ctx.parse()).join('\n');
  }
}

class DNClassContext extends DNContext {
  DNClassContext(internal) : super(internal);

  @override
  String parse() {
    var result = '';

    if (internal is ClassDeclarationContext) {
      ClassDeclarationContext aClassDeclarationContext = internal;
      String className = aClassDeclarationContext
          ?.normalClassDeclaration()
          ?.identifier()
          ?.text;
      if (className != null) {
        result += ("class " + className + " {\n");
        result += this.children.map((ctx) => ctx.parse()).join('\n');
        result += ("}\n");
      }
    }
    return result;
  }
}

class DNInterfaceContext extends DNContext {
  DNInterfaceContext(internal) : super(internal);

  @override
  String parse() {
    var result = '';

    if (internal is InterfaceDeclarationContext) {
      InterfaceDeclarationContext aInterfaceDeclarationContext = internal;
      String className = aInterfaceDeclarationContext
          ?.normalInterfaceDeclaration()
          ?.identifier()
          ?.text;
      if (className != null) {
        result += ("abstract class " + className + " {\n");
        result += this.children.map((ctx) => ctx.parse()).join('\n');
        result += ("}\n");
      }
    }
    return result;
  }
}

class DNInterfaceMethodDeclaration extends DNMethodContext {
  DNInterfaceMethodDeclaration(internal) : super(internal);

  @override
  String parse() {
    if (internal is InterfaceMethodDeclarationContext) {
      InterfaceMethodDeclarationContext aMethodNode = internal;
      String methodStatement = '';
      MethodHeaderContext headerContext = aMethodNode.methodHeader();
      addHeader(headerContext, methodStatement);
      addBody(methodStatement);
      return methodStatement;
    }
    return "";
  }

  @override
  void addBody(String methodStatement) {
    methodStatement += ";";
    print("addBody1 ${methodStatement}");
  }
}

class DNMethodContext extends DNContext {
  DNMethodContext(internal) : super(internal);

  void addHeader(MethodHeaderContext aHeaderContext, String statement) {
    MethodDeclaratorContext aDeclaratorNode = aHeaderContext.methodDeclarator();
    ResultContext aResultNode = aHeaderContext?.result();
    if (aResultNode != null) {
      statement += (aResultNode.text + " ");
    }
    if (aDeclaratorNode != null) {
      statement += aDeclaratorNode.identifier().text + "(";
      FormalParameterListContext paramsList =
          aDeclaratorNode.formalParameterList();
      if (paramsList != null) {
        FormalParametersContext frontParams = paramsList?.formalParameters();
        if (frontParams != null) {
          frontParams.formalParameters()?.forEach((param) {
            statement += CompileContext.getContext()
                .convertType2Dart(param.unannType().text);
            statement += " ";
            statement += param.variableDeclaratorId().text;
            statement += ", ";
          });
        }

        FormalParameterContext lastParam =
            paramsList?.lastFormalParameter()?.formalParameter();
        if (lastParam != null) {
          statement += CompileContext.getContext()
              .convertType2Dart(lastParam.unannType().text);
          statement += " ";
          statement += lastParam.variableDeclaratorId().text;
        }
      }
    }
  }

  void addBody(String statement) {
    statement += "{}";
  }

  bool checkAssessable(MethodDeclarationContext aMethodNode) {
    var isPublic = false;
    aMethodNode.methodModifiers()?.forEach((m) {
      if (m.PUBLIC() != null) {
        isPublic = true;
      }
    });
    return isPublic;
  }

  @override
  String parse() {
    if (internal is MethodDeclarationContext) {
      MethodDeclarationContext aMethodNode = internal;
      if (!checkAssessable(aMethodNode)) {
        return "";
      }
      String methodStatement = '';
      MethodHeaderContext headerContext = aMethodNode.methodHeader();
      addHeader(headerContext, methodStatement);
      addBody(methodStatement);

      return methodStatement;
    }
    return "";
  }
}

class DNFieldContext extends DNContext {
  DNFieldContext(internal) : super(internal);

  @override
  String parse() {
    if (internal is FieldDeclarationContext) {
      FieldDeclarationContext aFieldContext = internal;
      bool isPublic = false;
      aFieldContext.fieldModifiers()?.forEach((aModifierContext) {
        if (aModifierContext.PUBLIC() != null) {
          isPublic = true;
        }
      });
      if (!isPublic) {
        return "";
      }
      String type = CompileContext.getContext()
          .convertType2Dart(aFieldContext.unannType().text);
      VariableDeclaratorListContext aDeclaratorListContext =
          aFieldContext.variableDeclaratorList();
      if (aDeclaratorListContext != null) {
        String statement = '';
        aDeclaratorListContext
            ?.variableDeclarators()
            ?.forEach((aDeclaratorContext) {
          String value =
              aDeclaratorContext.variableDeclaratorId()?.identifier()?.text;
          if (type != null && value != null) {
            statement += '${type} get${toUpperCaseFirstV(value)}(){}';
            statement +=
                'void set${toUpperCaseFirstV(value)}(${type} ${value}){}';
          }
        });
        return statement;
      }
    }
    return "";
  }
}

String toUpperCaseFirstV(String value) {
  if (value == null || value.length == 0) {
    return "";
  }
  if (value.length > 1) {
    return '${value[0].toUpperCase()}${value.substring(1)}';
  } else {
    return value.toUpperCase();
  }
}
